# 5.2 MySQL 엔진의 잠금
- 스토리지 엔진 레벨과 MySQL 엔진 레벨로 나눌 수 있다.
- MySQL엔진 레빌의 잠금은 모든 스토리지 엔진에 영향을 미치지만, 스토리지 엔진 레벨의 잠금은 스토리지 엔진간 상호간 영향을 미치지 않는다.
- MySQL 엔진 제공하는 기능
  - 메타데이터 락: 테이블 구조를 잠그는 기능
  - 네임드 락: 사용자의 필요에 맞게 사용할 수 있게 하는 기능

## 5.2.1 글로벌 락
- FLUSH TABLES WITH READ LOCK 명령으로 획득 가능
- MySQL에서 제공하는 잠금 가운데 가장 범위가 크다.
- 글로벌 락을 획득하면 SELECT를 제외한 대부분의 DDL문장이나 DML 문장을 실행하는 경우 글로벌 락이 해제될 때까지 해당 문장이 대기 상태로 남는다.
- 글로벌 락이 영향을 미치는 범위는 MySQL 서버 전체이며, 작업 대상 테이블이나 데이터베이스가 다르더라도 동일하게 영향을 미친다.
- 여러 데이터베이스에 존재하는 MyISAM아니 MEMORY 테이블에 대해 mysqldump로 일관된 백업을 받아야 할 때는 글로벌 락을 사용해야 한다.
- InnoDB 스토리지 엔진은 트랜잭션을 지원하기 때문에 일관된 데이터 상태를 위해 모든 데이터 변경 작업을 멈출 필요는 없다.
- MySQL 8.0부터 InnoDB가 기본 스토리지 엔진으로 채택되면서 조금 더 가벼운 글로벌 락의 필요성이 기면서 Xtrabackup이나 Enterprise Backup과 같은 백업 툴들의 안정적인 실행을 위해 백업 락이 도입했다.
- 특정 세션에서 백업 락을 획득하면 모든 세션에서 다음과 같이 테이블의 스키마가 사용자의 인증 관련 정보를 변경할 수 없게 된다.
  - 데이터베이스 및 테이블 등 모든 객체 생성 및 변경, 삭제
  - REPAIR TABLE과 OPTIMIZE TABLE 명령
  - 사용자 관리 및 비밀번호 변경
- 하지만 백업 락은 일반적인 테이블의 데이터 변경은 허용된다.
- 주로 백업은 레플리카 서버에서 실행된다.
  - 레플리카 서버
    - 복제된 데이터를 가지는 서버
    - 소스 서버에서 데이터가 변경되면 레플리카 서버에서는 변경 내역을 소스 서버로부터 전달받아 자신의 데이터에 반영함으로써 소스 서버와 데이터를 동기화시킨다.
- FLUSH TABLES WITH READ LOCK 명령사용해 글로벌 락을 획득하면 복제는 백업 시간만큼 지연될 수밖에 없다.
- 백업이 실패하면 다시 실행시킨 시킨만큼 백업을 실행해야 하기때문에 MySQL 서버의 백업 락은 이런 목적으로 도입됬으며, 정상적으로 복제는 실행되지만 백업의 실패를 막기 위해 DDL 명령이 실행되면 복제를 일시 중지하는 역활을 한다.


## 5.2.2 테이블 락
- 개별 테이블 단위로 설정되는 잠금
- 명시적 또는 묵시적으로 특정 테이블의 락을 획득할 수 있다.

### 명시적 테이블 락
- 명시적으로는 "LOCK TABLES table_name [READ | WRITE]" 명령으로 특정 테이블의 락을 획득할 수 있다.
- 명시적으로 획득한 잠금은 UNLOCK TABLES 명령으로 잠금을 반납(해제)할 수 있다.
- 특별한 상황이 아니면 애플리케이션에서 사용할 필요가 거의 없다.
- 명시적으로 테이블을 잠그는 작업은 글로벌 락과 동일하게 온라인 작업에 상당히 영향을 미친다.

### 묵시적 테이블락
- 쿼리가 실행되는 동안 자동으로 획득됬다가 쿼리가 완료된 후 자동 해제된다.
- InnoDB 테이블의 경우 스토리지 엔진 차원에서 레코드 기반의 잠금을 제공하기 때문에 단순 데이터 변경 쿼리로 인해 묵시적인 테이블 락이 설정되지는 않는다. → InnoDB 테이블에도 테이블 락이 설정되지만 대부분의 데이터 변경(DML) 쿼리에서는 무시되고 스키마를 변경하는 쿼리(DDL)의 경우에만 영향을 미친다.

## 5.2.3 네임드 락
- GET_LOCK() 함수를 이용해 임의의 문자열에 대해 잠금을 설정할 수 있다.
- 특징은 대상이 테이블이나 레코드 또는 AUTO_INCREAMENT와 같은 데이터베이스 객체가 아니라는 것이다.
- 단순히 사용자가 저장한 문자열(String)에 대해 획득하고 반납(해제)하는 잠금이다.
- 자주 사용하지 않는 락이다.
- 많은 레코드에 대해서 복잡한 요건으로 레코드를 변경하는 트랜잭션에 유용하게 사용할 수 있다.
- MySQ 8.0 버전부터는 네임드 락을 중첩해서 사용할 수 있게 됬으며, 현재 새션에서 획득한 네임드 락을 한 번에 모두 해제하는 기능도 추가됬다.

## 5.2.4 메타데이터 락
- 데이터베이스 객체(대표적으로 테이블이나 뷰 등)의 이름이나 구조를 변경하는 경우에 획득하는 잠금이다.
- 명시적으로 획득하거나 해제할 수 있는 것이아니고 "RENAME TABLE tab_a TO tab_b" 같이 테이블의 이름을 변경하는 경우 자동으로 획득하는 잠금이다.

### RENAME TABLE
- 원본 이름과 변경될 이름 두 개 모두 한꺼번에 잠금을 설정한다.
- RENAME TABLE 명령문에 두 개이상 RENAME 작업을 한번에 실행하면 "Table not found rank" 같은 상황을 발생시키지 않고 적용하는 것이 가능하다.
- rank 테이블이 존재하지 않을 경우 "Table not found rank" 오류가 발생한다.

